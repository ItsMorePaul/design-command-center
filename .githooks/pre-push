#!/usr/bin/env bash
set -euo pipefail

# Enforce DCC deploy version policy:
# Before pushing, SITE_VERSION and SITE_TIME in server.ts must differ from origin/main.

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

if [[ ! -f "server.ts" ]]; then
  exit 0
fi

extract_vals() {
  local content="$1"
  local version time
  version=$(printf '%s' "$content" | sed -n "s/^const SITE_VERSION = '\([^']*\)'.*/\1/p" | head -n1)
  time=$(printf '%s' "$content" | sed -n "s/^const SITE_TIME = '\([^']*\)'.*/\1/p" | head -n1)
  printf '%s|%s' "$version" "$time"
}

local_vals=$(extract_vals "$(cat server.ts)")

# If remote branch doesn't exist yet, allow first push.
if ! git show origin/main:server.ts >/dev/null 2>&1; then
  exit 0
fi

remote_vals=$(extract_vals "$(git show origin/main:server.ts)")

if [[ "$local_vals" == "$remote_vals" ]]; then
  echo ""
  echo "‚ùå Push blocked: SITE_VERSION/SITE_TIME in server.ts match origin/main."
  echo "Rule: Update site version metadata before Railway deploy/push."
  echo ""
  echo "Current: $local_vals"
  echo "Remote : $remote_vals"
  echo ""
  echo "Update server.ts, then push again."
  exit 1
fi

exit 0
